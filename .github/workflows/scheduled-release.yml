name: Scheduled Release
on:
  push:
    branches: [ leland/testing ]
  workflow_dispatch:
jobs:
  create_release:
    runs-on: ubuntu-latest
    env:
      LATEST_RELEASE: replace
      TEMPFILE: replace
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.17'
      - run: go version
      - name: go get
        run: |
          go install github.com/kisom/goutils/cmd/certdump@latest
          go install github.com/cloudflare/cfssl/cmd/...@latest
          go install github.com/cloudflare/cfssl_trust/...@latest
      - name: Setup git user
        run: |
          git config --global user.name "$(git --no-pager log --format=format:'%an' -n 1)"
          git config --global user.email "$(git --no-pager log --format=format:'%ae' -n 1)"
      - name: Check repo
        run: |
          echo "TEMPFILE=$(mktemp)" >> $GITHUB_ENV
          AUTOMATED_RELEASE=true ./release.sh
          cat ${{ env.TEMPFILE }}
      - name: Set env
        run: |
          echo "LATEST_RELEASE=$(cfssl-trust -d cert.db releases | awk ' NR==1 { print $2 }')" >> $GITHUB_ENV
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          branch: release/${{ env.LATEST_RELEASE }}
      - name: Tag release
        run: |
          git tag trust-store-${{ env.LATEST_RELEASE }}
          git push origin trust-store-${{ env.LATEST_RELEASE }}